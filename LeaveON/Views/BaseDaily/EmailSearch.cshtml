@model IEnumerable<jsaosorio.Models.Recipient>
@{
  ViewBag.Title = "DNCSearch";
}


<section class="content">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            Email

          </h3>
        </div>


        <div class="card-body">
          <table id="dnctable" class="display" style="width:100%">
            <thead>
              <tr>
                <th></th>
                <th>
                  Domain
                </th>
                <th>
                  deal
                </th>
                <th>
                  agent
                </th>
                <th>
                  Cor
                </th>
                <th>
                  Neg
                </th>
                <th>
                  date
                </th>
                <th>
                  type
                </th>
                <th>
                  datechange
                </th>
                @*<th>
                    other1
                  </th>
                  <th>
                    other2
                  </th>
                  <th>
                    other3
                  </th>*@
                <th>
                  Traffic_Share
                </th>
                <th>
                  Change
                </th>
                <th>
                  Rank
                </th>
                <th>
                  Monthly_Visits
                </th>
                <th>
                  FileName
                </th>

              </tr>
            </thead>

          </table>
          @*<input type="button" id="btnSelectedRows" value="Send Email" />*@
          @*<button id="btnSelectedRows">Show Selected Rows</button>*@
          <button id="ShowModal" type="button" class="btn btn-warning" data-toggle="modal" data-target="#myModal">
            Load Selected Domain's Email(s)
          </button>
          @*<button type="button" class="btn btn-primary btn-block btn-lg" data-toggle="modal" data-target="#myModal">
              Open modal
            </button>*@
        </div>
      </div>
    </div>
  </div>

</section>

<!-- Button trigger modal -->
<!-- The Modal -->
<div class="modal" id="myModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Select Emails</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      @{ Html.RenderPartial("_EmailSearch", Model);}


      @* --------upload template file---- *@

      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Choose Template File and Send Email</h3>
            <div class="form-group">
              @*@Html.LabelFor(model => model.userLeavePolicy.AnnualOffDays, "Annual Off Days", htmlAttributes: new { @class = "card-title " })*@

              @*@Html.EditorFor(model => model.userLeavePolicy.AnnualOffDays, new { htmlAttributes = new { @class = "form-control" } })*@


              @*<div class="alert-icon">

                </div>*@
              <br /> <br />
              @*(1) Please chosse file. This file should contain Annual off days record in three comma separated columns (CSV) <mark>Date,Description</mark> format*@
              (1)

              <input type="file" id="FileUpload1" />


              @*       @Html.ValidationMessageFor(model => model.userLeavePolicy.AnnualOffDays, "", new { @class = "text-danger" })*@

              @*<br />*@
              <br />
              <br />
              @*<div class="alert alert-default-light" role="alert">*@
              (2)
              <input class="btn btn-info" type="button" id="btnUpload" value="Send Email" />
              @*</div>*@

              <div style="display:none" id="emailAlert" class="alert alert-success" role="alert">
                Email(s) Sent
              </div>

              @*<br />*@

            </div>
            <div id="NewData">
              @{ if (ViewBag.AnnualLeaves != null)
                {
                  Html.RenderPartial("_DisplayAnnualLeaves");
                } }



            </div>
            @*<table id="customFields" class="table table-bordered table-hover  " role="grid">
              </table>
              <a class="btn btn-default" href="javascript:void(0);" id="AnnualOffDays" style="background-color: #ffcc5c">Add Off Day  </a>*@
          </div>
        </div>
      </div>



      @* ---------------------- *@

      <!-- Modal footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>




@*<div id="test1"></div>*@

@*<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css" rel="stylesheet" />

  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap4.min.js"></script>*@


<link href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/select/1.3.3/css/select.dataTables.min.css" rel="stylesheet" />

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/select/1.3.3/js/dataTables.select.min.js"></script>


<script>
  $(document).ready(function () {
    $("#dnctable").DataTable({
      "ajax": {
        "url": "/BaseDaily/GetEmailsList",
        "type": "POST",
        "datatype": "json"
      },
      "columns": [
        { "data": "selected", "name": "selected" },
        {
          "data": "Domain", "name": "Domain",
          "render": function (data, type, full) {
            return '<a href="/BaseHistoricals/Index?domain=' + full.Domain + '" data-toggle="tooltip" data-placement="top" title="View Domain Details">' + full.Domain + '</a>'

          }
        },
        { "data": "deal", "name": "deal" },
        { "data": "agent", "name": "agent" },
        { "data": "Cor", "name": "Cor" },
        { "data": "Neg", "name": "Neg" },
        { "data": "date", "name": "date" },
        { "data": "type", "name": "type" },
        { "data": "datechange", "name": "datechange" },
        //{ "data": "other1", "name": "other1" },
        //{ "data": "other2", "name": "other2" },
        //{ "data": "other3", "name": "other3" },
        { "data": "Traffic_Share", "name": "Traffic_Share" },
        { "data": "Change", "name": "Change" },
        { "data": "Rank", "name": "Rank" },
        { "data": "Monthly_Visits", "name": "Monthly_Visits" },
        { "data": "FileName", "name": "FileName" },


      ],

      "serverSide": "true",
      "order": [0, "asc"],
      "processing": "true",
      "language": {
        "processing": "processing... please wait"
      },
      columnDefs: [{
        data: null,
        defaultContent: '',
        orderable: false,
        className: 'select-checkbox',
        targets: 0
      }],
      select: {
        style: 'os',
        selector: 'td:first-child'
      },
      order: [[1, 'asc']]


    });

    // CSHTML
    $('#ShowModal').click(function () {
      $("#emailAlert").hide();
      var myArr = [];
      var selectedRows = table.rows('.selected').data().map(function (item) { return item.Domain; });
      for (var i = 0; i < selectedRows.length; i++) {
        myArr.push(selectedRows[i]);
      }
      $.ajax({
        url: '/BaseDaily/GetSelectedRows',
        type: "POST",
        data: { 'obj': myArr }
      })
        .done(function (data) {
          // res containing list of domains and its emails
          /*alert(res);*/

          //var parsed_data = JSON.parse(res);
          //alert(parsed_data);
          //alert('s');
          $("#NewData").html(data);

          //$("#NewData").html(res);
          //alert($("#NewData").html());


        })
        .fail(function (res) {
          alert('Error');
        })

    });

    


    var table = $('#dnctable').DataTable();
    $('#example tbody').on('click', 'tr', function () {
      $(this).toggleClass('selected');
    });

    //$('.modal').click(function () {
    //  //alert(table.rows('.selected').data().length + ' row(s) selected');
    //  /*$('#modal').modal('show');*/
    //  $(".btn").click(function () {
    //    $("#exampleModal").modal('show');
    //  });

    //});

    //$('#showModal').click(function () {
    //  alert(table.rows('.selected').data().length + ' row(s) selected');

    //});

    //$('#myModal').modal('toggle');
    //$('#myModal').modal('show');
    //$('#myModal').modal('hide');

  });

  $('#btnUpload').click(function () {

    
    
    // Checking whether FormData is available in browser
    if (window.FormData !== undefined) {

      var fileUpload = $("#FileUpload1").get(0);
      var files = fileUpload.files;

      // Create FormData object
      var fileData = new FormData();

      // Looping over all files and add it to FormData object
      for (var i = 0; i < files.length; i++) {
        fileData.append(files[i].name, files[i]);
      }

      //$('select').change((e) => {
        var selectedEmails = $("option:selected").map(function () { return this.value }).get();
        //alert(selectedEmails);
        //console.log(selected);
      //});
      // Adding one more key to FormData object
      //fileData.append('username', 'Manas');
      //alert('1');
      $.ajax({
        url: '/BaseDaily/UploadAndSend',
        type: "POST",
        contentType: false, // Not to set any content header
        processData: false, // Not to process data
        data: fileData,
        //data: {'fileData': fileData, 'selectedEmails': selectedEmails },
        //data: JSON.stringify({ 'selectedEmails': selectedEmails }),
        success: function (result) {
          //alert(result);
          //alert('4');
          //$("#NewData").html(result);
          $("#emailAlert").show();
        },
        error: function (err) {
          alert(err.statusText);
          //alert('5');
        }
      });
    } else {
      alert("Error.");
    }

  });

</script>


